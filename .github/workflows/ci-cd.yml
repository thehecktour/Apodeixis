name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test-and-report:
    name: Test and Notify API
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v2

      - name: ğŸ› ï¸ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: ğŸš€ Send deploy data for my API
        env:
          API_URL: https://patroa.onrender.com/deploys
        run: |
          echo "Montando payload JSON para a API..."

          commit_message="${{ github.event.head_commit.message }}"
          commit_timestamp="${{ github.event.head_commit.timestamp }}"
          author_name="${{ github.event.head_commit.author.name }}"
          author_email="${{ github.event.head_commit.author.email }}"
          committer_name="${{ github.event.head_commit.committer.name }}"
          committer_email="${{ github.event.head_commit.committer.email }}"
          pr_number="${{ github.event.pull_request.number }}"
          pr_title="${{ github.event.pull_request.title }}"
          pr_user="${{ github.event.pull_request.user.login }}"
          pr_base="${{ github.event.pull_request.base.ref }}"
          pr_head="${{ github.event.pull_request.head.ref }}"

          JSON=$(cat <<EOF
          {
            "commit_hash": "${{ github.sha }}",
            "commit_message": "$commit_message",
            "commit_timestamp": "$commit_timestamp",
            "author": "${{ github.actor }}",
            "author_username": "$author_name",
            "author_email": "$author_email",
            "committer_name": "$committer_name",
            "committer_email": "$committer_email",
            "branch": "${{ github.ref_name }}",
            "ref": "${{ github.ref }}",
            "base_ref": "${{ github.base_ref }}",
            "event_name": "${{ github.event_name }}",
            "repository": "${{ github.repository }}",
            "repository_owner": "${{ github.repository_owner }}",
            "repository_url": "https://github.com/${{ github.repository }}",
            "repository_full_name": "${{ github.repository }}",
            "workflow": "${{ github.workflow }}",
            "workflow_job": "${{ github.job }}",
            "workflow_run_id": "${{ github.run_id }}",
            "workflow_run_number": "${{ github.run_number }}",
            "workflow_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "pull_request_number": "$pr_number",
            "pull_request_title": "$pr_title",
            "pull_request_user": "$pr_user",
            "pull_request_base": "$pr_base",
            "pull_request_head": "$pr_head",
            "status": "success",
            "deployment_status": "success",
            "triggered_by": "${{ github.actor }}"
          }
          EOF
          )
                    echo "Enviando para API:"
                    echo "$JSON" | jq .
          
                    curl -X POST "$API_URL" \
                      -H "Content-Type: application/json" \
                      -d "$JSON"
